---
title: "Wine and climate exploratory work"
output:
  pdf_document: default
  html_document: default
bibliography: wine-and-climate.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(cdlTools)
library(raster)
library(stars)
library(spatstat)
library(maptools)
library(rgdal)
```

### Winemaking regions in California

Wine production in California accounts for over 90% of the total for the United States, making it the 4th largest wine producing region in the world [@cahill2007]. California production occurs mainly in two regions: the warmer and drier climates of the Great Central Valley, and the cooler areas along the coast [@cahill2007].

### What are the most productive regions?

Using the R package `cdlTools`, we found the acreage of wine by county within California.

```{r, echo = F, eval = F}

if (process){
  
cal <- getCDL("California", 2015)
cal <- cal[[1]]

  
rast <- cal
inc <- seq(0,1,0.05)

for (i in 1:length(inc)){
  ymin_ <- rast@extent@ymin + (rast@extent@ymax - rast@extent@ymin)*inc[i]
  ymax_ <- rast@extent@ymin + (rast@extent@ymax - rast@extent@ymin)*inc[i+1]
  if (is.na(ymax_)) break
  
  message(paste("ymin =",ymin_,"ymax =",ymax_))
  
  ext <- raster::extent(rast@extent@xmin,
                rast@extent@xmax,
                ymin_,
                ymax_)
  
  clipped_rast <- crop(rast, ext)
  message("Clipping raster")
  # plot(clipped_rast)
  clipped_rast[clipped_rast != 69] <- NA
  
  if (i != 1){
    message("Merging rasters...")
    wine_areas <- raster::mosaic(wine_areas, clipped_rast, fun = "mean")
    # plot(wine_areas)
  } else {
    wine_areas <- clipped_rast
  }
  message("Done merging")
  # plot(wine_areas)
}

} else {
  load(here::here("data/wine_areas.rdata"))
}

```

```{r get-counties, echo = F}
ca <- st_read(here::here("data/CA_Counties/CA_Counties_TIGER2016.shp")) %>% 
  dplyr::select(NAME) %>% 
  st_transform(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")

ca <- readOGR(here::here("data/CA_Counties"))
ca_owin <- as(ca, "owin")
# sonoma <- ca %>% filter(NAME == "Sonoma")

# wine_points <- as(wine_areas, "SpatialPointsDataFrame")
wine_ppp <- as(wine_points, "ppp")
marks(wine_ppp) <- NULL
Window(wine_ppp) <- NULL
plot(wine_ppp, main=NULL, cols=rgb(0,0,0,.2))
# wine_sf <- as(wine_points, "sf")

Q <- quadratcount(wine_ppp, nx= 5, ny=20)
sonoma_rast <- st_intersection(sonoma, wine_sf)


ggplot() +
  geom_sf(data = sonoma) +
  geom_sf(data = sonoma_rast)

```
