---
title: "Wine and climate exploratory work"
output:
  pdf_document: default
  html_document: default
bibliography: wine-and-climate.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(cdlTools)
library(raster)
library(stars)
library(spatstat)
library(maptools)
library(rgdal)
```

### Winemaking regions in California

Wine production in California accounts for over 90% of the total for the United States, making it the 4th largest wine producing region in the world [@cahill2007]. California production occurs mainly in two regions: the warmer and drier climates of the Great Central Valley, and the cooler areas along the coast [@cahill2007].

### What are the most productive regions?

Using the R package `cdlTools`, we found the acreage of wine by county within California.

```{r, echo = F, eval = F}

if (process){
  
cal <- getCDL("California", 2015)
cal <- cal[[1]]

  
rast <- cal
inc <- seq(0,1,0.05)

for (i in 1:length(inc)){
  ymin_ <- rast@extent@ymin + (rast@extent@ymax - rast@extent@ymin)*inc[i]
  ymax_ <- rast@extent@ymin + (rast@extent@ymax - rast@extent@ymin)*inc[i+1]
  if (is.na(ymax_)) break
  
  message(paste("ymin =",ymin_,"ymax =",ymax_))
  
  ext <- raster::extent(rast@extent@xmin,
                rast@extent@xmax,
                ymin_,
                ymax_)
  
  clipped_rast <- crop(rast, ext)
  message("Clipping raster")
  # plot(clipped_rast)
  clipped_rast[clipped_rast != 69] <- NA
  
  if (i != 1){
    message("Merging rasters...")
    wine_areas <- raster::mosaic(wine_areas, clipped_rast, fun = "mean")
    # plot(wine_areas)
  } else {
    wine_areas <- clipped_rast
  }
  message("Done merging")
  # plot(wine_areas)
}

} else {
  load(here::here("data/wine_areas.rdata"))
}

```

```{r get-counties, echo = F}
ca <- st_read(here::here("data/CA_Counties/CA_Counties_TIGER2016.shp")) %>% 
  dplyr::select(NAME) %>% 
  st_transform(crs = "+proj=aea +lat_1=29.5 +lat_2=45.5 +lat_0=23 +lon_0=-96 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs")

ca <- readOGR(here::here("data/CA_Counties"))
ca_owin <- as(ca, "owin")
# sonoma <- ca %>% filter(NAME == "Sonoma")

# wine_points <- as(wine_areas, "SpatialPointsDataFrame")
wine_ppp <- as(wine_points, "ppp")
marks(wine_ppp) <- NULL
Window(wine_ppp) <- NULL
plot(wine_ppp, main=NULL, cols=rgb(0,0,0,.2))
# wine_sf <- as(wine_points, "sf")

Q <- quadratcount(wine_ppp, nx= 5, ny=20)
sonoma_rast <- st_intersection(sonoma, wine_sf)


ggplot() +
  geom_sf(data = sonoma) +
  geom_sf(data = sonoma_rast)

```


```{r overlay-counties, echo = F}

```

#### Asymmetric warming over coastal California and its impact on the premium wine industry

@nemani2001

**Introduction**

* Ocean and land temperatures tend to covary in coastal regions of western North America
    * Caused by the horizontal transport of water vapor

* Increased water vapor results in increased dewpoint temperatures that raise minimum temperatures along the coast.
    * Higher minimum temperatures mean fewer frost events and a longer-frost free growing season length
    
* Why are grapes responsive to long-term changes in climate?
    * The winegrape, *Vitis vinifera*, is a long-lived species (>50 years) is that is less fertilized and less irrigated than other agricultural crops.

* What environmental variables are associated with high quality wines?
    * Low frost damage in mild winters (Considered to be January, February, and March)
    * Early and even budburst, flowering, and development during warm springs (April, May, June)
    * Optimal maturation with low summer temperature variability (July, August, September)
    
**Methods**

* Climate data included SST, sea-level pressure (SLP), and specific humidity (*q*)
    * Time series of SST was developed for a 5&deg; x 5&deg; section of ocean off of central CA

* Lower SLP in the Pacific, and in particular during the winter, brings stronger winds blowing into CA. 
  * Winters with low SLPs tend to also bring warmer temperatures to CA
  
* Covariability between Pacific SSTs and coastal CA temps was tested by averaging air temperatures in the north, central, and south coastal areas (data from NCDC)

* Daily dewpoint temperatures (T<sub>dew</sub>) were taken from San Diego and San Francisco airports
* Cloud cover was also collected at these airports

* Study areas were **Napa and Sonoma Valleys (NSV)**

* Some important biophysical variables were estimated for viticulture
    * Frost frequency
        * The number of days in a year with T<sub>min</sub> < 0&deg;C
    * Growing Degree Days (GDD)
        * Accumulated heat units above a base temperature
    * Vapor Pressure Deficits
        * Difference in vapor pressures at T<sub>dew</sub> and T<sub>max</sub> during the growing season
    * Growing season length
        * Date of winegrape flowering was estimated 
